# FROM python:3.12-slim
FROM huggingface/transformers-torch-light:latest

# RUN apt-get update \
#     && apt-get upgrade -y \
#     && apt-get install -y --no-install-recommends cmake make build-essential g++  wget \
#     && apt-get clean \
#     && rm -rf /var/lib/apt/lists/* /tmp/*

WORKDIR /espresso

COPY . .
RUN rm -r app/web app/slack
RUN pip install --no-cache-dir -r requirements-api.txt
RUN pip install --no-cache-dir -r pybeansack/requirements.txt

# RUN mkdir -p .models
# RUN wget https://huggingface.co/soumitsr/GIST-small-Embedding-v0-Q8_0-GGUF/resolve/main/gist-small-embedding-v0-q8_0.gguf -O .models/gist-small-embedding-v0-q8_0.gguf
# ENV EMBEDDER_MODEL=.models/gist-small-embedding-v0-q8_0.gguf
ENV EMBEDDER_MODEL=avsolatorio/GIST-small-Embedding-v0
ENV EMBEDDER_CTX=512
ENV HF_HOME=.models

EXPOSE 8080
CMD ["fastapi", "run", "app/apirouter.py", "--port", "8080", "--host", "0.0.0.0"]
